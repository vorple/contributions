!function(vorple){"use strict";function eToInt(x){var e;return Math.abs(x)<1?(e=parseInt(x.toString().split("e-")[1]),e&&(x*=Math.pow(10,e-1),x="0."+new Array(e).join("0")+x.toString().substring(2))):(e=parseInt(x.toString().split("+")[1]),e>20&&(e-=20,x/=Math.pow(10,e),x+=new Array(e+1).join("0"))),x}function getHeader(content){return"*"===content.charAt(0)?content.substr(0,content.indexOf("\n")+1):""}function handshake(filename){var gameHandshake=FS.readFile(filename,{encoding:"utf8"}),header=getHeader(gameHandshake),content=gameHandshake.substr(header.length);"Callooh!"===content?(vorple.debug.log("Handshake passed, Vorple story confirmed"),FS.unlink(filename),FS.writeFile(filename,header+"Callay!",{encoding:"utf8"})):vorple.debug.log('Handshake failed, expected "Callooh!" but received "'+content+'" instead')}const VERSION="3.0";vorple.debug=function(text){console.log(text),haven.buffer.append("["+text+"]\n",0)},vorple.error=function(text){haven.error(text)},vorple.fileClosed=function(filename){if(filename.indexOf("VpHndshk.glkdata")!==-1)return void handshake(filename);if(filename.indexOf("VpJSEval.glkdata")!==-1){var retval,code=FS.readFile(filename,{encoding:"utf8"}),header=getHeader(code);code=code.substr(header.length),vorple.debug.log("Evaluating: "+code);try{retval=function(){return(0,eval)(code)}()}catch(e){vorple.error("JavaScript from story file threw an error: "+e.message)}retval="string"==typeof retval?'"'+retval+'"':"number"==typeof retval?Math.abs(retval)>1e20?eToInt(retval):""+retval:void 0===retval?"undefined":"function"==typeof retval||"symbol"==typeof retval?retval.toString():"undefined"!=typeof Set&&retval instanceof Set?JSON.stringify(Array.from(retval)):retval===1/0?"Infinity":retval===-(1/0)?"-Infinity":retval!==retval?"NaN":JSON.stringify(retval),vorple.debug.log("Return value: "+retval),FS.writeFile("VpJSRtrn.glkdata",header+retval,{encoding:"utf8"})}},vorple.init=function(){vorple.prompt.init(),haven.start({enginePrompt:!1,engineFontFamily:!1,options:vorple.options,unicode:!0,virtualStoryfile:"storyfile.gblorb"}),haven.assets.addCallback(function(done){FS.syncfs(!0,function(){FS.writeFile("/gamedata/VpHndshk.glkdata","");try{FS.unlink("/gamedata/VpJSEval.glkdata")}catch(e){}try{FS.unlink("/gamedata/VpJSRtrn.glkdata")}catch(e){}FS.syncfs(!1,done)})}),window.vex&&(vex.defaultOptions.className="vex-theme-plain")},vorple.options={},vorple.requireVersion=function(requiredVersion){var thisVer=VERSION.split("."),reqVer=(""+requiredVersion).split("."),mismatch=function(){vorple.error("Vorple version "+requiredVersion+" was requested, but Vorple is at version "+VERSION)};if(thisVer[0]<reqVer[0])return void mismatch();if(!(thisVer[0]>reqVer[0]||1===reqVer.length))return thisVer[1]<reqVer[1]?void mismatch():void(thisVer[1]>reqVer[1]||2===reqVer.length||2===thisVer.length||thisVer[2]<reqVer[2]&&mismatch())},vorple.version=VERSION,window.vorple=vorple}(window.vorple||{}),function(vorple){"use strict";var debug={},DEBUGGING=!1;debug.log=function(text){return!!DEBUGGING&&(console.log(text),haven.buffer.append("["+text+"]\n",0),!0)},debug.off=function(){return DEBUGGING=!1,!0},debug.on=function(){return DEBUGGING=!0,!0},debug.status=function(){return DEBUGGING},debug.toggle=function(){return DEBUGGING=!DEBUGGING},vorple.debug=debug}(window.vorple),function(){"use strict";var h={},stylehints=[];stylehints[0]={bold:!1,italic:!1,underline:!1},stylehints[1]={italic:!0},stylehints[2]={},stylehints[3]={bold:!0},stylehints[4]={bold:!0},h.setStyle=function(style){if(stylehints[style])for(var i in stylehints[style])haven.style.set(i,stylehints[style][i],0)},h.setStyleHint=function(style,hint,value){stylehints[style]||(stylehints[style]={bold:!1,italic:!1,underline:!1});var st=stylehints[style];switch(hint){case 4:st.bold=1===value;break;case 5:st.italic=1===value;break;case 6:}},window.Module.arguments=["-q","-u","/storyfile.gblorb"],vorple.haven=h}(),function(){"use strict";function fadeOut(element,callback){function next(volume){sound.volume=Math.max(volume,0),volume>0?fadeOutTimer=setTimeout(function(){next(volume-.05)},50):($sound.remove(),callback())}var $sound=$(element),sound=$sound.get(0);clearTimeout(fadeOutTimer),$sound.data("stopping",!0),next(sound.volume-.05)}function timeNextTrack(){clearTimeout(musicPauseTimer),0===musicQueue.length&&playlist.length>0&&(musicQueue=playlist.slice()),0!==musicQueue.length&&(musicPauseTimer=setTimeout(function(){var next=musicQueue.shift();next&&audio.playMusic(next)},1e3))}var fadeOutTimer,musicPauseTimer,audio={},musicQueue=[],playlist=[];audio.clearPlaylist=function(){playlist=[],musicQueue=[]},audio.currentMusicPlaying=function(){var $music=$(".vorple-music");return 0===$music.length?null:$music.data("stopping")?musicQueue.length>0?musicQueue[0]:playlist.length>0?playlist[0]:null:$music.attr("src")},audio.isAudioPlaying=function(){return audio.isEffectPlaying()||audio.isMusicPlaying()},audio.isEffectPlaying=function(){var isEffectPlaying=!1;return $(".vorple-sound").each(function(){if(audio.isElementPlaying(this))return isEffectPlaying=!0,!1}),isEffectPlaying},audio.isElementPlaying=function(audioElement){var elem=$(audioElement).get(0);return!(!(elem&&elem.currentTime>0)||elem.paused)},audio.isMusicPlaying=function(){var $music=$(".vorple-music");return 0!==$music.length&&(musicQueue.length>0||(playlist.length>0||!$music.data("stopping")&&audio.isElementPlaying($music)))},audio.playMusic=function(url,loop){var $music=$(".vorple-music");clearTimeout(musicPauseTimer),$music.length>0&&$music.attr("src")===url||0===$music.length&&musicQueue[0]===url?(clearTimeout(fadeOutTimer),$music.prop("volume",1).data("stopping",!1).prop("loop",!!loop).get(0).play()):audio.isElementPlaying(".vorple-music")?(musicQueue.unshift(url),fadeOut($music,timeNextTrack)):($music.remove(),$('<audio class="vorple-audio vorple-music">').attr("src",url).prop("loop",!!loop).appendTo("body").on("ended",timeNextTrack).get(0).play())},audio.setPlaylist=function(list,looping){return 0===list.length?(musicQueue=[],void(playlist=[])):(musicQueue=list.slice(1),looping&&(playlist=list.slice()),void(audio.isElementPlaying(".vorple-music")&&$(".vorple-music").attr("src")===list[0]||audio.playMusic(list[0])))},audio.stopMusic=function(){var $music=$(".vorple-music");musicQueue=[],playlist=[],$music.length>0&&fadeOut($music,timeNextTrack)},vorple.audio=audio}(),function(){"use strict";var layout={};layout.block=function(){$(document).on("keydown.vorple.uiblock",function(e){return e.stopImmediatePropagation(),!1}),$('<div class="uiblock">').on("click.vorple.uiblock",function(e){return e.stopImmediatePropagation(),!1}).appendTo("body")},layout.closeTag=function(targetWindow){var current=haven.window.container.get(targetWindow||0);return"window0"!==current.id&&(haven.buffer.flush(targetWindow||0),haven.window.container.set(current.parentNode,targetWindow||0),!0)},layout.focus=function(targetElement,targetWindow){var $target=$(targetElement);return 0!==$target.length&&(haven.buffer.flush(),haven.window.container.set($target.last().get(0),targetWindow||0),!0)},layout.openTag=function(tagName,classes,targetWindow){var elem=document.createElement(tagName),current=haven.window.container.get(targetWindow||0);elem.className=classes,haven.buffer.flush(targetWindow||0),haven.window.container.append(elem,current),haven.window.container.set(elem,targetWindow||0)},layout.scrollTo=function(target){var $target=$(target);if(0===$target.length)return!1;var pagePosition=$("body").scrollTop(),targetPosition=$target.offset().top,targetHeight=$target.height(),windowHeight=$(window).height(),pageBottom=$(document).height()-windowHeight,halfway=windowHeight/2+pagePosition,offset=30;return!(targetPosition>=pagePosition+offset&&targetPosition<=halfway&&targetPosition+targetHeight<=pagePosition+windowHeight)&&($("html, body").stop().animate({scrollTop:Math.min(Math.max(targetPosition-offset,0),pageBottom)},500),!0)},layout.scrollToEnd=function(){$("html, body").stop().animate({scrollTop:$(document).height()-$(window).height()},500)},layout.unblock=function(){$(".uiblock").remove(),$(document).off("keydown.vorple.uiblock")},vorple.layout=layout}(),function(){"use strict";function runCommandQueue(){if(commandQueue.length>0){var command=commandQueue.shift();prompt.setValue(command.cmd),prompt.submit(command.silent)}}var prompt={},commandQueue=[];prompt.hide=function(){$(haven.prompt.get()).addClass("force-hidden")},prompt.init=function(){haven.prompt.get().addEventListener("lineinputReady",runCommandQueue)},prompt.queueCommand=function(cmd,silent){commandQueue.push({cmd:cmd,silent:!!silent}),haven.prompt.isReady()&&runCommandQueue()},prompt.setPrefix=function(prefix,escaped){var newPrefix=prefix;return escaped||(newPrefix=$("<div>").text(prefix).html()),haven.prompt.prefix.set(newPrefix),newPrefix},prompt.setValue=function(value){$(haven.prompt.get()).find("#lineinput-field").val(value)},prompt.submit=function(silent){haven.prompt.get().dispatchEvent(new CustomEvent("submit",{detail:{silent:!!silent}}))},prompt.unhide=function(){$(haven.prompt.get()).removeClass("force-hidden"),haven.prompt.resizeInput()},vorple.prompt=prompt}();